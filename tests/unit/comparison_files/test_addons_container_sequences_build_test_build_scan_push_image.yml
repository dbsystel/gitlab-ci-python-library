stages:
- build
- check
- push
build-kaniko:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint:
    - ''
  stage: build
  script:
  - mkdir -p /kaniko/.docker
  - 'echo "{\"credHelpers\": {\"quay.io\": \"quay-login\"}}" > /kaniko/.docker/config.json'
  - mkdir -p image
  - executor --context /path/to/project --dockerfile /path/to/project/Dockerfile --tarPath
    ./image/gitlab-ci-project.tar --no-push --destination quay.io/gitlab-ci-project:11.22.33
  cache:
    paths: &id001
    - ./image
    key: my-awsome-feature-branch
check-dive:
  image:
    name: wagoodman/dive:latest
    entrypoint:
    - ''
  stage: check
  script:
  - set -eo pipefail
  - dive docker-archive://./image/gitlab-ci-project.tar --ci |tee /path/to/project/dive.txt
  artifacts:
    paths:
    - dive.txt
  cache:
    paths: *id001
    key: my-awsome-feature-branch
check-trivy:
  image:
    name: aquasec/trivy:latest
    entrypoint:
    - ''
  stage: check
  script:
  - set -eo pipefail
  - trivy image --input ./image/gitlab-ci-project.tar --no-progress --exit-code 1
    |tee /path/to/project/trivi.txt
  artifacts:
    paths:
    - trivi.txt
  cache:
    paths: *id001
    key: my-awsome-feature-branch
push-crane:
  image:
    name: gcr.io/go-containerregistry/crane:latest
    entrypoint:
    - ''
  stage: push
  script:
  - mkdir -p /kaniko/.docker
  - 'echo "{\"credHelpers\": {\"quay.io\": \"quay-login\"}}" > /kaniko/.docker/config.json'
  - crane validate --tarball ./image/gitlab-ci-project.tar
  - crane push ./image/gitlab-ci-project.tar quay.io/gitlab-ci-project:11.22.33
  cache:
    paths: *id001
    key: my-awsome-feature-branch
