stages:
- lint
- test
- build
- deploy
lint-isort:
  script:
  - pip3 install --upgrade isort
  - isort --check .
  stage: lint
lint-flake8:
  script:
  - pip3 install --upgrade flake8
  - flake8
  stage: lint
test-pytest:
  script:
  - pip3 install --upgrade -r requirements.txt
  - pytest
  stage: test
test-evaluate-git-tag-pep404-conformity:
  script:
  - pip3 install --upgrade gcip
  - python3 -m gcip.script_library.evaluate_git_tag_pep404_conformity
  rules:
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
  stage: test
build-bdist-wheel:
  script:
  - pip3 install --upgrade -r requirements.txt
  - python3 setup.py bdist_wheel
  artifacts:
    paths:
    - dist/
  stage: build
test-mypy:
  script:
  - pip3 install --upgrade mypy
  - mypy package_dir
  stage: test
build-pages-python-sphinx:
  script:
  - pip3 install --upgrade -r docs/requirements.txt
  - sphinx-build -b html -E -a docs public/${CI_COMMIT_REF_NAME}
  rules:
  - if: $CI_COMMIT_REF_NAME == "master"
    when: on_success
    allow_failure: false
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
  artifacts:
    paths:
    - public
  stage: build
deploy-twine-upload-dev:
  script:
  - pip3 install --upgrade twine
  - python3 -m twine upload --non-interactive --disable-progress-bar dist/*
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    when: never
    allow_failure: false
  - if: $CI_COMMIT_TAG
    when: never
    allow_failure: false
  - if: $CI_COMMIT_REF_NAME == "master"
    when: on_success
    allow_failure: false
  variables:
    TWINE_REPOSITORY_URL: https://my.artifactory.net/pypi/dev-repository
    TWINE_USERNAME: $ARTIFACTORY_DEV_USER
    TWINE_PASSWORD: $ARTIFACTORY_DEV_PASSWORD
  stage: deploy
deploy-twine-upload-stable:
  script:
  - pip3 install --upgrade twine
  - python3 -m twine upload --non-interactive --disable-progress-bar dist/*
  rules:
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
  variables:
    TWINE_REPOSITORY_URL: https://my.artifactory.net/pypi/prod-repository
    TWINE_USERNAME: $ARTIFACTORY_PROD_USER
    TWINE_PASSWORD: $ARTIFACTORY_PROD_PASSWORD
  stage: deploy
