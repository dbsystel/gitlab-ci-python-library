stages:
- lint
- test
- build
- deploy
lint-isort:
  stage: lint
  script:
  - pip3 install --upgrade isort
  - isort --check .
lint-flake8:
  stage: lint
  script:
  - pip3 install --upgrade flake8
  - flake8
test-pytest:
  stage: test
  script:
  - pip3 install --upgrade -v -r requirements.txt
  - pytest
test-evaluate-git-tag-pep440-conformity:
  image:
    name: thomass/gcip:0.3.0
  stage: test
  script:
  - python3 -m gcip.tools.evaluate_git_tag_pep440_conformity
  rules:
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
build-bdist-wheel:
  stage: build
  script:
  - pip3 install --upgrade -v -r requirements.txt
  - python3 setup.py bdist_wheel
  artifacts:
    paths:
    - dist/
test-mypy:
  stage: test
  script:
  - pip3 install --upgrade mypy
  - mypy test_package_dir
build-pages-python-sphinx:
  stage: build
  script:
  - pip3 install --upgrade -v -r docs/requirements.txt
  - sphinx-build -b html -E -a docs public/${CI_COMMIT_REF_NAME}
  rules:
  - if: $CI_COMMIT_BRANCH == "main"
    when: on_success
    allow_failure: false
  - if: $CI_COMMIT_BRANCH == "master"
    when: on_success
    allow_failure: false
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
  artifacts:
    paths:
    - public
deploy-twine-upload-dev:
  stage: deploy
  script:
  - pip3 install --upgrade twine
  - python3 -m twine upload --non-interactive --disable-progress-bar dist/*
  variables:
    TWINE_USERNAME: $$ARTIFACTORY_DEV_USER
    TWINE_PASSWORD: $$ARTIFACTORY_DEV_PASSWORD
    TWINE_REPOSITORY_URL: https://my.artifactory.net/pypi/dev-repository
  rules:
  - if: $CI_COMMIT_TAG
    when: never
    allow_failure: false
  - when: on_success
    allow_failure: false
deploy-twine-upload-stable:
  stage: deploy
  script:
  - pip3 install --upgrade twine
  - python3 -m twine upload --non-interactive --disable-progress-bar dist/*
  variables:
    TWINE_USERNAME: $$ARTIFACTORY_PROD_USER
    TWINE_PASSWORD: $$ARTIFACTORY_PROD_PASSWORD
    TWINE_REPOSITORY_URL: https://my.artifactory.net/pypi/prod-repository
  rules:
  - if: $CI_COMMIT_TAG
    when: on_success
    allow_failure: false
